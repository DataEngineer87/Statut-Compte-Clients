name: CI - Account Status Prediction

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Cloner le dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configurer Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Construire l'image Docker
      - name: Build Docker image
        run: docker build -t statusclients-api .

      # 4️⃣ Lancer le conteneur en arrière-plan
      - name: Run Docker container
        run: |
          docker run -d -p 8000:8000 --name statusclients-api statusclients-api
          sleep 5  # attendre que le serveur démarre

      # 5️⃣ Tester l'API avec curl ou Python
      - name: Test /predict endpoint
        run: |
          curl -X POST http://127.0.0.1:8000/predict \
            -H "Content-Type: application/json" \
            -d '{
              "gender": "Male",
              "marital_status": "Single",
              "employment_status": "Employed",
              "education_level": "Bachelor",
              "subscription_type": "Premium",
              "age_group": "35-44",
              "number_of_children": 2,
              "children_per_age": 0.5,
              "log_annual_income": 10.5,
              "country": "France"
            }'

      # 6️⃣ Arrêter et supprimer le conteneur après le test
      - name: Clean up
        run: |
          docker stop statusclients-api
          docker rm statusclients-api
